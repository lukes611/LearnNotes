<!DOCTYPE html>
<html>
</html>
	<head>
		<link rel="stylesheet" type="text/css" href="primarycss.css">
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
    
		<script src="jquery-1.11.2.min.js"></script>
		<script src="R2.js"></script>
		<script src="LPoly.js"></script>
		<script src="LG.js"></script>
		<script src="musictheory.js"></script>
	</head>
	<body>
        <div class="canvasHolder">
		  <canvas width="600" height="500" id="myc"></canvas>
        </div>
		<div id="controls_container">
			<div class="btc" >treblecleff<input class="btccb" id="tc" type="checkbox" checked="true" /></div>
			<div class="btc">basscleff<input class="btccb" id="bc" checked="true" type="checkbox" /></div>
			<button id="start_button">Start</button>
		</div>
		<div id="note_buttons_container" >
		</div>
		<script type="text/javascript">
			
			function Game(cb)
			{
                //graphics object
				this.g = new LG();
                
                //get the width and height ofthe canvas
				var wh = {w:document.getElementById('myc').width,h:document.getElementById('myc').height};
                
                //initialize as on screen canvas
				this.g.init_onscreen('myc', wh.w, wh.h);
				
                //access the timer display
				this.timer_div = $('<div id="timer_div">TIME</div>');
                
                //add buttons (a,b,c,d,e,f,g)
				this.buttons = this.add_buttons();
                
                //create a new fader
				this.fx = new lg_fader(this.g);
                
                //access start button
				this.start_button = $('#start_button');
                
                //me
				var me = this;
                
                //when the user clicks start: start
				this.start_button.click(function(){me.start();});
                
                //create a new musictheory object
				this.mt = new MTheory(cb);
                
                //index is: 
				this.index = 0;
                
                //score is the score
				this.score = 0;
                
                //arrays for guesses, answers and notes
				this.guesses = [];
				this.answers = [];
				this.notes = [];
                
                //some sort of state
				this.type = 0;
                
                //access cleff divs
				this.tc = $('#tc');
				this.bc = $('#bc');
                //controls container is all the start menu options
				this.controls_container = $('#controls_container');
			}
			
            //switch the home-screen menu on or off
			Game.prototype.menu_switch = function(on_off)
			{
				if(on_off){
                    //fade in controls
					this.controls_container.fadeIn(30);
                    //fade out each button
					this.buttons.forEach(function(b){b.fadeOut(30);});
                    //fade out timer
					this.timer_div.fadeOut(30);
				}
				else{
                    //do the opposite, turn on abcdefg blah
					this.controls_container.fadeOut(30);
					this.buttons.forEach(function(b){b.fadeIn(30);});
					this.timer_div.fadeIn(30);
				}
			};
			
			Game.prototype.add_buttons = function()
			{
				var note_buttons_container = $('#note_buttons_container');
				var l = 'a b c d e f g'.split(/\s/g);
				var me = this;
				var rv = [];
				l.forEach(function(e, i)
				{
					(function()
					{
						var _e = e;
						var _me = me;
						var btn = $('<button class="note_buttons">'+_e+'</button>');
						btn.click(function()
						{
							_me.play(_e);
						});
						rv.push(btn);
						btn.css('display', 'none');
						note_buttons_container.append(btn);
					})();
				});
				note_buttons_container.append(this.timer_div);
				this.timer_div.css('display', 'none');
				return rv;
			};
			
			Game.prototype.start = function()
			{
				this.menu_switch(false);
				
				this.sub_game_init();
				this.score = 0;
				var t = 0;
				var m = this;
				var mx = 60;
				var iv = setInterval(function()
				{
					var seconds = (Math.round(t*10)/10);
					m.timer_div.html('seconds: ' + seconds);
					t+=0.1;
					if(seconds >= mx)
					{
						m.menu_switch(true);
						//s, p, c, size
						var st = 'score: ' + m.score;
						m.fx.fadeOut(function()
						{
							m.g.string(st, new R2(60, 120), 'black', 40);
						});
						
						clearInterval(iv);
					}
				}, 100);
			};
			
			Game.prototype.sub_game_init = function()
			{
				var m = this;
				this.fx.fadeOut(function()
				{
					if($('#tc').prop('checked') && $('#bc').prop('checked'))
					{
						m.type = Math.round(Math.random());
					}else if($('#bc').prop('checked'))
					{
						m.type = 1;
					}else
					{
						m.type = 0;
					}
					m.answers = [];
					m.guesses = [];
					m.index = 0;
					m.notes = [];
					for(var i = 0; i < 7; i++)
					{
						var v = Math.floor(Math.random() * 13);
						m.notes.push(v);
						m.answers.push(m.mt.note_names(m.type)[v]);
					}
					m.update_display();
				});
			};
			
			Game.prototype.play = function(c)
			{
				if(c == this.answers[this.index]) this.score++;
				this.guesses.push(c == this.answers[this.index]);
				this.index++;
				this.update_display();
				if(this.index < 7)
					return;
				else this.sub_game_init();
			};
			
			Game.prototype.update_display = function()
			{
				this.g.clear('white');
				this.mt.notes(this.g, new R2(10, 120), this.type, 60, this.notes, this.guesses);
			};
			
			Game.prototype.draw_start_screen = function()
			{
				this.g.clear('white');
				this.mt.notes(this.g, new R2(10, 120), 0, 60, [0, 1, 2, 8, 3, 7, 11]);
			};
			
			$(document).ready(function()
			{
				var g = new Game(function()
				{
					g.draw_start_screen();
				});
			});	
		</script>
	</body>
</html>